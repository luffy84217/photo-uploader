function handleMode(e,t){var n=$("svg"),a=$("div.effect-brush"),o=$("div.effect-filter");switch(e){case"crop":n.classList.remove("hide"),a.classList.remove("show");break;case"brush":n.classList.add("hide"),a.classList.add("show"),o.classList.remove("show");break;case"filter":n.classList.add("hide"),o.classList.add("show"),a.classList.remove("show")}}function handleFilter(e,t){switch(e){case"origin":ctx.filter="none",ctx.drawImage(photo,0,0);break;case"bright":ctx.filter="saturate(120%) brightness(120%)",ctx.drawImage(photo,0,0);break;case"contrast":ctx.filter="contrast(150%)",ctx.drawImage(photo,0,0);break;case"classical":ctx.filter="saturate(80%) brightness(80%)",ctx.drawImage(photo,0,0);break;case"gray-scale":ctx.filter="grayscale(100%)",ctx.drawImage(photo,0,0)}}function handleColor(e,t){switch(e){case"black":ctx.strokeStyle="#000";break;case"blue":ctx.strokeStyle="#78c5d6";break;case"deep-blue":ctx.strokeStyle="#459ba8";break;case"green":ctx.strokeStyle="#79c267";break;case"light-green":ctx.strokeStyle="#c5d647";break;case"yellow":ctx.strokeStyle="#f5d63d";break;case"orange":ctx.strokeStyle="#f28c33";break;case"pink":ctx.strokeStyle="#e868a2";break;case"purple":ctx.strokeStyle="#bf62a6"}}function handleSize(e){switch(e){case"large":ctx.lineWidth=24;break;case"medium":ctx.lineWidth=16;break;case"small":ctx.lineWidth=8}}function brushended(){cropBegin.x=$(".handle.handle--nw").x.baseVal.value+3,cropBegin.y=$(".handle.handle--nw").y.baseVal.value+3,cropEnd.x=$(".handle.handle--se").x.baseVal.value+3,cropEnd.y=$(".handle.handle--se").y.baseVal.value+3,cropSize.width=cropEnd.x-cropBegin.x,cropSize.height=cropEnd.y-cropBegin.y,console.log(cropSize)}function handleFile(){var e=input.files;photo.className="photo",photo.src=window.URL.createObjectURL(e[0]),photo.addEventListener("load",handlePhoto)}function handlePhoto(e){$(".effect-mode").classList.add("show"),$$(".effect-filter-img").forEach(function(e){e.src=photo.src}),ctx.clearRect(0,0,canvas.width,canvas.height),ctx.drawImage(photo,0,0);var t=$("svg").childNodes[0];t&&t.remove(),svg.append("g").attr("class","brush").call(brush).call(brush.move,[[cropBegin.x,cropBegin.y],[cropEnd.x,cropEnd.y]])}function handleSubmit(e){if(window.confirm("The photo has been modified. Do you want to upload ?")){var t=document.createElement("img"),n=document.createElement("canvas"),a=n.getContext("2d");n.width=cropSize.width,n.height=cropSize.height,t.src=canvas.toDataURL(),t.onload=function(e){a.drawImage(t,cropBegin.x,cropBegin.y,cropSize.width,cropSize.height,0,0,n.width,n.height);var o=new XMLHttpRequest,r={};r.dataURL=n.toDataURL();var l=JSON.stringify(r);if(!o)return alert("Cannot create an XMLHTTP instance"),!1;o.open("PUT","/api/upload"),o.setRequestHeader("Content-type","application/json; charset=utf-8"),o.onreadystatechange=function(){4===o.readyState&&(200===o.status?alert(o.responseText):(alert("There was a problem with the request."),console.error("There was a problem with the request.")))},o.send(l)}}}var $=function(e,t){return t||(t=document),t.querySelector(e)},$$=function(e,t){return t||(t=document),t.querySelectorAll(e)},input=$("input"),photo=new Image,preview=$(".preview"),canvas=$("canvas"),svg=$("svg"),ctx=canvas.getContext("2d"),cropBegin={x:0,y:0},cropEnd={x:200,y:200},cropSize={width:0,height:0},mouse={x:0,y:0};canvas.addEventListener("mousemove",function(e){mouse.x=e.pageX-this.offsetLeft,mouse.y=e.pageY-this.offsetTop},!1),ctx.lineWidth=24,ctx.lineJoin="round",ctx.lineCap="round",ctx.strokeStyle="#000",canvas.addEventListener("mousedown",function(e){ctx.beginPath(),ctx.moveTo(mouse.x,mouse.y),canvas.addEventListener("mousemove",onPaint,!1)},!1),canvas.addEventListener("mouseup",function(){canvas.removeEventListener("mousemove",onPaint,!1)},!1);var onPaint=function(){ctx.lineTo(mouse.x,mouse.y),ctx.stroke()};$(".effect-mode button.crop").addEventListener("click",handleMode.bind(null,"crop")),$(".effect-mode button.brush").addEventListener("click",handleMode.bind(null,"brush")),$(".effect-mode button.filter").addEventListener("click",handleMode.bind(null,"filter"));var filters=$$(".effect-filter-img");filters[0].addEventListener("click",handleFilter.bind(null,"origin")),filters[1].addEventListener("click",handleFilter.bind(null,"bright")),filters[2].addEventListener("click",handleFilter.bind(null,"contrast")),filters[3].addEventListener("click",handleFilter.bind(null,"classical")),filters[4].addEventListener("click",handleFilter.bind(null,"gray-scale"));var colorBtns=$$(".effect-brush-color button");colorBtns[0].addEventListener("click",handleColor.bind(null,"black")),colorBtns[1].addEventListener("click",handleColor.bind(null,"blue")),colorBtns[2].addEventListener("click",handleColor.bind(null,"deep-blue")),colorBtns[3].addEventListener("click",handleColor.bind(null,"green")),colorBtns[4].addEventListener("click",handleColor.bind(null,"light-green")),colorBtns[5].addEventListener("click",handleColor.bind(null,"yellow")),colorBtns[6].addEventListener("click",handleColor.bind(null,"orange")),colorBtns[7].addEventListener("click",handleColor.bind(null,"pink")),colorBtns[8].addEventListener("click",handleColor.bind(null,"purple"));var sizeBtns=$$(".effect-brush-size button");sizeBtns[0].addEventListener("click",handleSize.bind(null,"large")),sizeBtns[1].addEventListener("click",handleSize.bind(null,"medium")),sizeBtns[2].addEventListener("click",handleSize.bind(null,"small"));var brush=d3.brush().on("end",brushended),svg=d3.select("svg");input.style.opacity=0,input.addEventListener("change",handleFile);var holder=document.getElementById("holder"),state=document.getElementById("status");window.FileReader,state.className="success",state.innerHTML="",holder.ondragover=function(){return this.className="hover",!1},holder.ondragend=function(){return this.className="",!1},holder.ondrop=function(e){this.className="",e.preventDefault();var t=e.dataTransfer.files[0];return photo.src=window.URL.createObjectURL(t),photo.addEventListener("load",handlePhoto),!1},$("button.submit").addEventListener("click",handleSubmit);